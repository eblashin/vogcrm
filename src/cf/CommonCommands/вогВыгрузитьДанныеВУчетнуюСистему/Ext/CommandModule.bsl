
&НаКлиенте
Процедура ОбработкаКоманды(ПараметрКоманды, ПараметрыВыполненияКоманды)
	
	Если ПараметрКоманды.Количество() = 0 Тогда
		ВызватьИсключение "Для выгрузки необходимо указать объект";
	КонецЕсли;
	
	Результат = ПолучитьРезультатВыгрузки(ПараметрКоманды);
	
	Если Результат.Успешно Тогда
		Картинка = БиблиотекаКартинок.Информация2_32;
	Иначе 
		Картинка = БиблиотекаКартинок.Ошибка32;
	КонецЕсли;
	
	ПоказатьОповещениеПользователя(НСтр("ru = 'Выгрузка данных в учетную систему...'"),, Результат.ТекстПояснения, Картинка);
	
КонецПроцедуры

&НаСервере
Функция ПолучитьРезультатВыгрузки(ПараметрКоманды)
	
	// ++ VOG Ульянов И.В. 19.03.2020 CRM-207
	Для каждого ЭлементМассива из ПараметрКоманды цикл
		Если ТипЗнч(ЭлементМассива) = Тип("СправочникСсылка.вогЮридическиеЛица") ИЛИ ТипЗнч(ЭлементМассива) = Тип("СправочникСсылка.вогТорговыеТочки") тогда
			ЗапросЮЛ = Новый Запрос;
			ЗапросЮЛ.Текст = 
				"ВЫБРАТЬ
				|	вогМенеджерыОбъектов.Владелец КАК Владелец,
				|	вогМенеджерыОбъектов.Подразделение КАК Подразделение,
				|	вогМенеджерыОбъектов.Роль КАК Роль,
				|	вогМенеджерыОбъектов.НаправлениеДеятельности КАК НаправлениеДеятельности,
				|	вогМенеджерыОбъектов.Менеджер КАК Менеджер,
				|	вогМенеджерыОбъектов.ДатаНачала КАК ДатаНачала,
				|	вогМенеджерыОбъектов.ДатаОкончания КАК ДатаОкончания
				|ИЗ
				|	РегистрСведений.вогМенеджерыОбъектов КАК вогМенеджерыОбъектов
				|ГДЕ
				|	вогМенеджерыОбъектов.Владелец = &Владелец";
			
			ЗапросЮЛ.УстановитьПараметр("Владелец", ЭлементМассива);
			ВыборкаЮЛ = ЗапросЮЛ.Выполнить().Выбрать();
			
			НаборЗаписейЮЛ = РегистрыСведений.вогМенеджерыДляОбмена.СоздатьНаборЗаписей();
			НаборЗаписейЮЛ.Отбор.Владелец.Установить(ЭлементМассива);
			Пока ВыборкаЮЛ.Следующий() Цикл
				ЗаписьЮЛ = НаборЗаписейЮЛ.Добавить();
				ЗаполнитьЗначенияСвойств(ЗаписьЮЛ, ВыборкаЮЛ);		
			КонецЦикла;
			НаборЗаписейЮЛ.Записать();
	
			вогИнтеграцияСУчетнойСистемой.ЗарегистрироватьДанныеКОтправкеВУчетнуюСистему(ЭлементМассива, Истина, Ложь, Ложь, "МенеджерыКонтрагентов");
		// +++ VOG Кулаков П.Л. 21.10.2020 CRM-991
		ИначеЕсли ТипЗнч(ЭлементМассива) = Тип("СправочникСсылка.Номенклатура") Тогда
			вогИнтеграцияСУчетнойСистемой.ЗарегистрироватьДанныеКОтправкеВУчетнуюСистему(ЭлементМассива, Истина, Истина);
			ПараметрКоманды.Удалить(ПараметрКоманды.Найти(ЭлементМассива));
		// --- VOG Кулаков П.Л.
		КонецЕсли;
	КонецЦикла;		
	// -- VOG Ульянов И.В. 19.03.2020 CRM-207
	
	Возврат вогИнтеграцияСУчетнойСистемой.ЗарегистрироватьДанныеКОтправкеВУчетнуюСистему(ПараметрКоманды);
	// Солодов В.В. Закомментировал 07.03.2019
	//Возврат вогИнтеграцияСУчетнойСистемой.ПолучитьРезультатОтправкиВУчетнуюСистему(ПараметрКоманды,,Истина, Истина);
	
КонецФункции

