// В данный модуль вынесены методы подсистемы CRM, вызываемые из модулей типовых объектов. 
// Выносить можно только те методы, которые не вызывают стандартные методы типового модуля или обработчики форм. 
// Т.е. вызывают только те методы, что тоже вынесены из типового или не содержат таких вызовов.

// Для каждого объекта необходимо задать свою #Область с именем объекта и модуля, как он называется в метаданных.

#Область ОпределениеФормОбъектов

Процедура ОбработкаПолученияФормОбъектовCRM(Источник, ВидФормы, Параметры, ВыбраннаяФорма, ДополнительнаяИнформация, СтандартнаяОбработка) Экспорт
	
	Если ТипЗнч(Источник) = Тип("ЗадачаМенеджер.ЗадачаИсполнителя") Тогда
		
		Если ВидФормы = "ФормаОбъекта" И Параметры.Свойство("Ключ") Тогда
			Если НЕ ЗначениеЗаполнено(Параметры.Ключ.БизнесПроцесс) Тогда
				
				// ++ VOG Солодов В.В. 05.09.2019 task 605
				МассивПользователей = Новый Массив;
				МассивПользователей.Добавить(Параметры.Ключ.Исполнитель);
				
				ЭтоДелегат = РегистрыСведений.вогИсполнителиРолейИДелегаты.ИсполнительЯвляетсяДелегатом(
					МассивПользователей,
					Пользователи.ТекущийПользователь(),
					"Анкеты");
				// -- VOG Солодов В.В. 05.09.2019
				
				Если (Параметры.Ключ.Исполнитель = Пользователи.ТекущийПользователь() Или ЭтоДелегат) // VOG Солодов В.В. 05.09.2019 task 605 // Добавлено Или ЭтоДелегат
					И ТипЗнч(Параметры.Ключ.Предмет) = Тип("ДокументСсылка.вогАнкета") Тогда
					
					Запрос = Новый Запрос;
					Запрос.Текст = 
					"ВЫБРАТЬ
					|	вогСтатусыОпросов.Анкета КАК Анкета
					|ИЗ
					|	РегистрСведений.вогСтатусыОпросов КАК вогСтатусыОпросов
					|ГДЕ
					|	вогСтатусыОпросов.Анкета = &Анкета";
					
					Запрос.УстановитьПараметр("Анкета",Параметры.Ключ.Предмет);
					
					Результат = Запрос.Выполнить();
					
					Если Результат.Пустой() Тогда
						ВыбраннаяФорма = "Задача.ЗадачаИсполнителя.Форма.CRM_ФормаЛичнойЗадачи";
					Иначе 	
						Параметры.Ключ = Параметры.Ключ.Предмет;
						ВыбраннаяФорма = "Документ.вогАнкета.Форма.ФормаДокумента";
					КонецЕсли; 
					
				Иначе 	
					ВыбраннаяФорма = "Задача.ЗадачаИсполнителя.Форма.CRM_ФормаЛичнойЗадачи";	
				КонецЕсли; 
				
				СтандартнаяОбработка = Ложь;
				
			ИначеЕсли ЗначениеЗаполнено(Параметры.Ключ.БизнесПроцесс)
				И ТипЗнч(Параметры.Ключ.БизнесПроцесс) = Тип("БизнесПроцессСсылка.CRM_БизнесПроцесс") Тогда
				
				СтандартнаяОбработка = Ложь;
				//+вог
				//ВыбраннаяФорма = "БизнесПроцесс.CRM_БизнесПроцесс.Форма.ФормаЗадачи";
				//Возврат;
				//-вог
				Если РегистрыСведений.CRM_ЗадачиПоИсправлениюКлиентскойБазы.ЭтоЗадачаПоИсправлениюКлиентскойБазы(Параметры.Ключ) <> Неопределено Тогда
					ВыбраннаяФорма = "БизнесПроцесс.CRM_БизнесПроцесс.Форма.ФормаЗадачи";
					// ++ Тищенко В.В. 14.02.2019
					// Если это поручение открывать форму задачи
					// Добавлено условие
					// И Параметры.Ключ.БизнесПроцесс.КартаМаршрута <> Справочники.CRM_КартыМаршрутов.Поручение 
				ИначеЕсли Параметры.Ключ.БизнесПроцесс.КартаМаршрута.ТипПроцесса = Перечисления.bpmТипыПроцессов.НезависимыйПроцесс 
					И Параметры.Ключ.БизнесПроцесс.КартаМаршрута <> Справочники.CRM_КартыМаршрутов.Поручение
					И Параметры.Ключ.БизнесПроцесс.КартаМаршрута <> Справочники.CRM_КартыМаршрутов.ПоручениеГрупповое // ++ VOG Солодов В.В. 21.08.2019 task 477 // добавил условие
					И Параметры.Ключ.БизнесПроцесс.КартаМаршрута <> Справочники.CRM_КартыМаршрутов.ПоручениеНовое Тогда // ++ VOG Солодов В.В. 31.07.2020 task 792 // добавил условие
					
					// ++ VOG Солодов В.В. 19.08.2019
					Предмет = Параметры.Ключ.БизнесПроцесс.Предмет;
					
					Если ТипЗнч(Предмет) = Тип("ДокументСсылка.вогАнкета")
						И Не РольДоступна("ПолныеПрава")
						И Предмет.ВариантОпроса.ИспользоватьФормуАнкетыВЗадаче Тогда
						Параметры.Ключ = Параметры.Ключ.БизнесПроцесс.Предмет;
						ВыбраннаяФорма = "Документ.вогАнкета.Форма.ФормаДокумента";
					Иначе
						ВыбраннаяФорма = "БизнесПроцесс.CRM_БизнесПроцесс.Форма.ФормаЗадачиНезависимыйПроцесс";
					КонецЕсли;
					// До изменения
					//ВыбраннаяФорма = "БизнесПроцесс.CRM_БизнесПроцесс.Форма.ФормаЗадачиНезависимыйПроцесс";
					// -- VOG Солодов В.В. 19.08.2019
					// -- Тищенко В.В. 
				ИначеЕсли Параметры.Ключ.БизнесПроцесс.КартаМаршрута.ТипПроцесса = Перечисления.bpmТипыПроцессов.ПроцессОбъекта
					И ЗначениеЗаполнено(Параметры.Ключ.БизнесПроцесс.Интерес) 
					И (ТипЗнч(Параметры.Ключ.БизнесПроцесс.Интерес) = Тип("ДокументСсылка.CRM_Интерес"))
					И ЗначениеЗаполнено(Параметры.Ключ.CRM_СостояниеИнтереса)
					И (Параметры.Ключ.БизнесПроцесс.Интерес.Ответственный = Параметры.Ключ.Исполнитель) Тогда
					Параметры.Ключ = Параметры.Ключ.БизнесПроцесс.Интерес;
					ВыбраннаяФорма = "Документ.CRM_Интерес.ФормаОбъекта";
				ИначеЕсли Параметры.Ключ.БизнесПроцесс.КартаМаршрута.ТипПроцесса = Перечисления.bpmТипыПроцессов.ПроцессОбъекта
					И ЗначениеЗаполнено(Параметры.Ключ.БизнесПроцесс.Интерес)
					И ЗначениеЗаполнено(Параметры.Ключ.CRM_СостояниеИнтереса) Тогда
					Параметры.Ключ = Параметры.Ключ.БизнесПроцесс.Интерес;
					ИсточникНов = ОбщегоНазначения.МенеджерОбъектаПоСсылке(Параметры.Ключ);
					CRM_МетодыМодулейМенеджеровДокументов.ОбработкаПолученияФормОбъектовCRM(ИсточникНов, ВидФормы, Параметры, ВыбраннаяФорма, ДополнительнаяИнформация, СтандартнаяОбработка)
				// ++ VOG Солодов В.В. 17.08.2020 CRM-827
				ИначеЕсли Параметры.Ключ.БизнесПроцесс.КартаМаршрута = Справочники.CRM_КартыМаршрутов.ПоручениеНовое Тогда
					
					// ++ VOG Солодов В.В. 01.06.2021 DEV-608
					ВыбраннаяФорма = вогБизнесПроцессыИЗадачиСервер.ОпределитьФормуЗадачи(Параметры.Ключ);
					// До изменения
					// ++ VOG Солодов В.В. 01.06.2021 DEV-601
					//ТочкиКонтроля = Новый Массив;
					//ТочкиКонтроля.Добавить("Действие2");
					//ТочкиКонтроля.Добавить("Действие3");
					//ТочкиКонтроля.Добавить("Действие4");
					//// -- VOG Солодов В.В. 01.06.2021 DEV-601
					//
					//РеквизитыЗадачи = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(
					//	Параметры.Ключ,
					//	"БизнесПроцесс, Исполнитель, Выполнена, ПринятаКИсполнению, CRM_ТочкаМаршрута",
					//	Истина);
					//
					//РеквизитыБП = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(
					//	РеквизитыЗадачи.БизнесПроцесс,
					//	"Автор, Ответственный",
					//	Истина);
					//
					//ТекущийПользователь = Пользователи.ТекущийПользователь();
					//
					//МассивАвторов = Новый Массив;
					//МассивАвторов.Добавить(РеквизитыБП.Автор);
					//МассивАвторов.Добавить(РеквизитыБП.Ответственный);
					//// ++ VOG Солодов В.В. 01.06.2021 DEV-601
					//Если Не ТочкиКонтроля.Найти(РеквизитыЗадачи.CRM_ТочкаМаршрута.Имя) = Неопределено Тогда
					//	МассивАвторов.Добавить(РеквизитыЗадачи.Исполнитель);
					//КонецЕсли;
					//// -- VOG Солодов В.В. 01.06.2021 DEV-601
					//
					//ПользовательЯвляетсяДелегатом = РегистрыСведений.вогИсполнителиРолейИДелегаты.ИсполнительЯвляетсяДелегатом(
					//	МассивАвторов,
					//	ТекущийПользователь,
					//	"ПроцессыИЗадачи",
					//	// ++ VOG Солодов В.В. 23.12.2020 DEV-44
					//	Ложь);
					//	// До изменения
					//	//Истина);
					//	// -- VOG Солодов В.В. 23.12.2020 DEV-44
					//
					//Если ТекущийПользователь = РеквизитыБП.Автор
					//	Или ТекущийПользователь = РеквизитыБП.Ответственный
					//	Или ПользовательЯвляетсяДелегатом Тогда
					//	
					//	Если ТекущийПользователь = РеквизитыЗадачи.Исполнитель
					//		И Не РеквизитыЗадачи.Выполнена
					//		И РеквизитыЗадачи.ПринятаКИсполнению
					//		// ++ VOG Солодов В.В. 01.06.2021 DEV-601
					//		И ТочкиКонтроля.Найти(РеквизитыЗадачи.CRM_ТочкаМаршрута.Имя) = Неопределено Тогда
					//		// До изменения
					//		//И Не РеквизитыЗадачи.CRM_ТочкаМаршрута.Имя = "Действие2"
					//		//И Не РеквизитыЗадачи.CRM_ТочкаМаршрута.Имя = "Действие3"
					//		//И Не РеквизитыЗадачи.CRM_ТочкаМаршрута.Имя = "Действие4" Тогда
					//		// -- VOG Солодов В.В. 01.06.2021 DEV-601
					//		
					//		ВыбраннаяФорма = "БизнесПроцесс.CRM_БизнесПроцесс.Форма.ФормаЗадачи";
					//		
					//	Иначе
					//		ВыбраннаяФорма = "БизнесПроцесс.CRM_БизнесПроцесс.Форма.вогМониторИсполненияПоручения";
					//	КонецЕсли;
					//	
					//Иначе
					//	
					//	Запрос = Новый Запрос;
					//	Запрос.Текст = 
					//	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
					//	|	CRM_БизнесПроцесс.Ссылка КАК Ссылка
					//	|ИЗ
					//	|	РегистрСведений.вогСписокИсполнителейПоручения КАК вогСписокИсполнителейПоручения
					//	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ БизнесПроцесс.CRM_БизнесПроцесс КАК CRM_БизнесПроцесс
					//	|		ПО вогСписокИсполнителейПоручения.БизнесПроцесс = CRM_БизнесПроцесс.Ссылка
					//	|			И (вогСписокИсполнителейПоручения.Контролер = ИСТИНА)
					//	|			И (вогСписокИсполнителейПоручения.Исполнитель В(&Пользователи))
					//	|			И (CRM_БизнесПроцесс.Ссылка = &БизнесПроцесс)";
					//	
					//	Если Не ПользовательЯвляетсяДелегатом Тогда
					//		МассивАвторов = Новый Массив;
					//	КонецЕсли;
					//	
					//	МассивАвторов.Добавить(ТекущийПользователь);
					//	
					//	Запрос.УстановитьПараметр("Пользователи", 	МассивАвторов);
					//	Запрос.УстановитьПараметр("БизнесПроцесс", 	РеквизитыЗадачи.БизнесПроцесс);
					//	
					//	РезультатЗапроса = Запрос.Выполнить();
					//	
					//	Если РезультатЗапроса.Пустой() Тогда
					//		ВыбраннаяФорма = "БизнесПроцесс.CRM_БизнесПроцесс.Форма.ФормаЗадачи";
					//	Иначе
					//		ВыбраннаяФорма = "БизнесПроцесс.CRM_БизнесПроцесс.Форма.вогМониторИсполненияПоручения";
					//	КонецЕсли;
					//	
					//КонецЕсли;
					// -- VOG Солодов В.В. 01.06.2021 DEV-608
					
				Иначе
					ВыбраннаяФорма = "БизнесПроцесс.CRM_БизнесПроцесс.Форма.ФормаЗадачи_Старая";
				// До Изменения
				//Иначе
				//	ВыбраннаяФорма = "БизнесПроцесс.CRM_БизнесПроцесс.Форма.ФормаЗадачи";
				// -- VOG Солодов В.В. 17.08.2020 CRM-827
				КонецЕсли;
			ИначеЕсли ВидФормы = "ФормаОбъекта" Тогда
				ПараметрыФормы = БизнесПроцессыИЗадачиВызовСервера.ФормаВыполненияЗадачи(Параметры.Ключ);
				ИмяФормыЗадачи = "";
				Результат = ПараметрыФормы.Свойство("ИмяФормы", ИмяФормыЗадачи);
				Если Результат Тогда
					ВыбраннаяФорма = ИмяФормыЗадачи;
					СтандартнаяОбработка = Ложь;
				КонецЕсли;
			КонецЕсли;
		ИначеЕсли ВидФормы = "ФормаОбъекта" Тогда
			Если Параметры.Свойство("Основание") И (ТипЗнч(Параметры.Основание) = Тип("ДокументСсылка.УдалитьCRM_Событие")
				ИЛИ ТипЗнч(Параметры.Основание) = Тип("ДокументСсылка.ЭлектронноеПисьмоВходящее")
				ИЛИ ТипЗнч(Параметры.Основание) = Тип("ДокументСсылка.ЭлектронноеПисьмоИсходящее")
				ИЛИ ТипЗнч(Параметры.Основание) = Тип("ДокументСсылка.CRM_КонтрольнаяТочкаПроекта") 
				ИЛИ ТипЗнч(Параметры.Основание) = Тип("СправочникСсылка.МаркетинговыеМероприятия")
				ИЛИ ТипЗнч(Параметры.Основание) = Тип("ДокументСсылка.CRM_Телемаркетинг"))
				ИЛИ ТипЗнч(Параметры.Основание) = Тип("ДокументСсылка.CRM_СообщениеМессенджера")
				Тогда
				СтандартнаяОбработка = Ложь;
				ВыбраннаяФорма = "Задача.ЗадачаИсполнителя.Форма.CRM_ФормаЛичнойЗадачи";
			КонецЕсли;
		ИначеЕсли ВидФормы = "ФормаСписка" Тогда
			СтандартнаяОбработка = Ложь;
			ВыбраннаяФорма = "Задача.ЗадачаИсполнителя.Форма.CRM_ФормаСписка";
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти // ОпределениеФормОбъектов
