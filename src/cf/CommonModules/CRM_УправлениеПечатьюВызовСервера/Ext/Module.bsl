////////////////////////////////////////////////////////////////////////////////
// Подсистема "Печать".
//
////////////////////////////////////////////////////////////////////////////////

#Область СлужебныеПроцедурыИФункции

Функция ПолучитьМакетИДанныеОбъектов(ИмяМакета, ОбъектыНазначения, НомерВарианта = Неопределено) Экспорт
	
	Перем ПутьКФайлуМакета, ДвоичныеДанныеМакета;
	
	Если Найти(ИмяМакета, "ПФ_DOC") > 0 Тогда
		ТипМакета = "DOC";
	КонецЕсли;
	
	Если Найти(ИмяМакета, "ПФ_ODT") > 0 Тогда
		ТипМакета = "ODT";
	КонецЕсли;
	
	МетаОбъект = Метаданные.НайтиПоТипу(ТипЗнч(ОбъектыНазначения[0]));
	
	ДвоичныеДанныеМакета = УправлениеПечатью.МакетПечатнойФормы("Документ.КоммерческоеПредложениеКлиенту."+ИмяМакета);
	
	ДанныеПоВсемОбъектам = Новый Соответствие;
	
	
	МассивИменТабличныхЧастей = Неопределено;
	
	Для Каждого ОбъектСсылка Из ОбъектыНазначения Цикл
		ДанныеОбъектаПоМакетам = Новый Соответствие;
		ПолученныеДанные = CRM_ОбщегоНазначенияСервер.CRM_ПолучитьДанныеОбъекта(ОбъектСсылка, НомерВарианта);
		ДанныеОбъектаПоМакетам.Вставить(ИмяМакета, ПолученныеДанные);
		
		ДанныеПоВсемОбъектам.Вставить(ОбъектСсылка, ДанныеОбъектаПоМакетам);
		
		Если МассивИменТабличныхЧастей = Неопределено Тогда
			Если ПолученныеДанные.Свойство("ТабличныеЧасти") Тогда
				МассивИменТабличныхЧастей = ПолученныеДанные.ТабличныеЧасти;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	ОписаниеОбластей = Новый Соответствие;
	ДвоичныеДанныеМакетов = Новый Соответствие;
	ТипыМакетов = Новый Соответствие;
	
	ДвоичныеДанныеМакетов.Вставить(ИмяМакета, ДвоичныеДанныеМакета);
	ТипыМакетов.Вставить(ИмяМакета, ТипМакета);
	
	ОписаниеОбластей.Вставить(ИмяМакета, CRM_ОбщегоНазначенияСервер.CRM_ПолучитьОписаниеОбластейМакетаОфисногоДокумента(МассивИменТабличныхЧастей));
	
	МакетыИДанные = Новый Структура("Данные, Макеты",
							ДанныеПоВсемОбъектам,
							Новый Структура("ОписаниеОбластей, ТипыМакетов, ДвоичныеДанныеМакетов",
											ОписаниеОбластей,
											ТипыМакетов,
											ДвоичныеДанныеМакетов));
	МакетыИДанные.Вставить("ЛокальныйКаталогФайловПечати", УправлениеПечатью.ПолучитьЛокальныйКаталогФайловПечати());
	
	Возврат МакетыИДанные;
	
КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

Процедура ПоместитьВариантНаПечатьВХранилище(ВариантНаПечать) Экспорт
	CRM_ХранилищеНастроек.Сохранить("_ВариантНаПечать", , ВариантНаПечать);
КонецПроцедуры	

Функция  ПолучитьВариантНаПечатьИзХранилища() Экспорт
	ВариантНаПечать = CRM_ХранилищеНастроек.Загрузить("_ВариантНаПечать");
	Если ВариантНаПечать = Неопределено Тогда
		ВариантНаПечать	= 0;
		ПоместитьВариантНаПечатьВХранилище(ВариантНаПечать);
	КонецЕсли;
	Возврат ВариантНаПечать;
КонецФункции

#КонецОбласти
