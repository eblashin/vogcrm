// +CRM
&НаКлиенте
Перем КэшСвойстваДинамическогоСписка;
// -CRM


#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Если Параметры.Свойство("АвтоТест") Тогда // Возврат при получении формы для анализа.
		Возврат;
	КонецЕсли;
	
	Если ПользователиКлиентСервер.ЭтоСеансВнешнегоПользователя() Тогда
		Отказ = Истина;
	КонецЕсли;
	// +CRM
	Если Параметры.Свойство("Респондент") Тогда
		Респондент = Параметры.Респондент;
		Элементы.Анкеты.Видимость = Истина;
		CRM_ПолучитьТаблицуАнкетРеспондента();
		Элементы.ПолеБыстрогоОтбора_Респондент.Видимость = Ложь;
		ПризнакФормаОткрытаПоПартнеру = Истина;
	Иначе
		Элементы.Анкеты.Видимость = Ложь;
	КонецЕсли;
	// Оформление списка
	//СвойстваДинамическогоСписка = CRM_ПолучитьСвойстваДинамическогоСпискаСервер();
	//CRM_ОбщегоНазначенияСервер.ПользовательскиеНастройкиСпискаПриСозданииНаСервере(ЭтаФорма, СвойстваДинамическогоСписка);
	// -CRM
КонецПроцедуры

#КонецОбласти

&НаКлиенте
Процедура СписокПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель, Группа)
	
	Отказ = Истина;
	
КонецПроцедуры

// +CRM

// АНКТИРОВАНИЕ

&НаКлиенте
Процедура CRM_ОбработкаОповещения(ИмяСобытия, Параметр, Источник)
	Если (ИмяСобытия = "Запись_Анкета") ИЛИ (ИмяСобытия = "Проведение_Анкета") Тогда
		CRM_ПолучитьТаблицуАнкетРеспондента();
		Элементы.Список.Обновить();
	КонецЕсли;
КонецПроцедуры 

&НаКлиенте
Процедура CRM_ТаблицаАнкетПередНачаломИзменения(Элемент, Отказ)
	Отказ = Истина;
	ТекущиеДанные = Элементы.ТаблицаАнкет.ТекущиеДанные;
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	Если ТипЗнч(ТекущиеДанные.АнкетаОпрос) = Тип("ДокументСсылка.Анкета") Тогда
		СтруктураПараметров = Новый Структура;
		СтруктураПараметров.Вставить("Ключ",ТекущиеДанные.АнкетаОпрос);
		СтруктураПараметров.Вставить("ТолькоФормаЗаполнения",Истина);
		Если ТекущиеДанные.Статус = "Отвеченные анкеты" Тогда
			СтруктураПараметров.Вставить("ТолькоПросмотр",Истина);
		КонецЕсли;
		ОткрытьФорму("Документ.Анкета.Форма.ФормаДокумента",СтруктураПараметров,Элемент);
	ИначеЕсли ТипЗнч(ТекущиеДанные.АнкетаОпрос) = Тип("ДокументСсылка.НазначениеОпросов") Тогда
		СтруктураПараметров = Новый Структура;
		ЗначенияЗаполнения 	= Новый Структура;
		ЗначенияЗаполнения.Вставить("Респондент", Респондент);
		ЗначенияЗаполнения.Вставить("Опрос", ТекущиеДанные.АнкетаОпрос);
		СтруктураПараметров.Вставить("ЗначенияЗаполнения", ЗначенияЗаполнения);
		СтруктураПараметров.Вставить("ТолькоФормаЗаполнения", Истина);
		ОткрытьФорму("Документ.Анкета.Форма.ФормаДокумента", СтруктураПараметров, Элемент);
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура CRM_ТаблицаАнкетПередУдалением(Элемент, Отказ)
	Отказ = Истина;
КонецПроцедуры

&НаКлиенте
Процедура CRM_ТаблицаАнкетПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель, Группа)
	Отказ = Истина;
КонецПроцедуры

&НаКлиенте
Процедура CRM_Обновить(Команда)
	CRM_ПолучитьТаблицуАнкетРеспондента();
КонецПроцедуры 

////////////////////////////////////////////////////////////////////////////////
// Быстрые отборы

&НаКлиенте
Процедура CRM_ПолеБыстрогоОтбораПриИзмененииОбщий(Элемент)
	CRM_ОбщегоНазначенияКлиентСервер.БыстрыйОтборПрименитьОтборКСписку(Список, Элемент, ЭтотОбъект);
КонецПроцедуры

&НаКлиенте
Процедура CRM_ПолеБыстрогоОтбора_ПроведенПриИзменении(Элемент)
	Если ПолеБыстрогоОтбора_Проведен = "Завершенные" Тогда
		CRM_ОбщегоНазначенияКлиентСервер.ИзменитьЭлементОтбораСписка(Список, "Проведен", Истина, Истина, ВидСравненияКомпоновкиДанных.Равно);
	ИначеЕсли ПолеБыстрогоОтбора_Проведен = "Незавершенные" Тогда
		CRM_ОбщегоНазначенияКлиентСервер.ИзменитьЭлементОтбораСписка(Список, "Проведен", Ложь, Истина, ВидСравненияКомпоновкиДанных.Равно);
	Иначе
		CRM_ОбщегоНазначенияКлиентСервер.ИзменитьЭлементОтбораСписка(Список, "Проведен");	
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура CRM_ПолеБыстрогоОтбора_ПроведенОчистка(Элемент, СтандартнаяОбработка)
	СтандартнаяОбработка = Ложь;
	CRM_ОбщегоНазначенияКлиентСервер.ИзменитьЭлементОтбораСписка(Список, "Проведен");
	ПолеБыстрогоОтбора_Проведен = "Все";	
КонецПроцедуры

&НаКлиенте
Процедура CRM_СписокПередНачаломИзменения(Элемент, Отказ)
	Отказ = Истина;
	ТекущиеДанные = Элементы.Список.ТекущиеДанные;
	Если ТекущиеДанные = Неопределено Тогда Возврат; КонецЕсли;
	СтруктураПараметров = Новый Структура;
	СтруктураПараметров.Вставить("Ключ", Элементы.Список.ТекущаяСтрока);
	СтруктураПараметров.Вставить("ТолькоФормаЗаполнения", Истина);
	Если CRM_МетодыФормДокументовСервер.АнкетаПроведена(Элементы.Список.ТекущаяСтрока) Тогда
		СтруктураПараметров.Вставить("ТолькоПросмотр", Истина);
	КонецЕсли;
	ОткрытьФорму("Документ.Анкета.ФормаОбъекта", СтруктураПараметров,Элемент);
КонецПроцедуры

&НаКлиенте
Процедура CRM_Подключаемый_КомандаВидСписка(Команда)
	СвойстваДинамическогоСписка = CRM_ПолучитьСвойстваДинамическогоСпискаКлиент();
	ОписаниеОповещения = Новый ОписаниеОповещения("Подключаемый_КомандаВидСпискаЗавершение", ЭтотОбъект, СвойстваДинамическогоСписка);
	CRM_ОбщегоНазначенияКлиент.ПользовательскиеНастройкиСпискаОбработкаВыбораНастройки(ЭтотОбъект, СвойстваДинамическогоСписка, Команда, ОписаниеОповещения);
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_КомандаВидСпискаЗавершение(ПризнакИзмененыНастройки, СвойстваДинамическогоСписка) Экспорт
	CRM_КомандаВидСпискаСервер(СвойстваДинамическогоСписка, ПризнакИзмененыНастройки);
КонецПроцедуры

&НаКлиенте
Функция CRM_ПолучитьСвойстваДинамическогоСпискаКлиент()
	Если ТипЗнч(КэшСвойстваДинамическогоСписка) <> Тип("Структура") Тогда
		КэшСвойстваДинамическогоСписка = CRM_ПолучитьСвойстваДинамическогоСпискаСервер();
	КонецЕсли;
	Возврат КэшСвойстваДинамическогоСписка;
КонецФункции

&НаСервере
Процедура CRM_ПолучитьТаблицуАнкетРеспондента()
	
	ТаблицаАнкет.Очистить();
	ПолученнаяТаблицаАнкет = Анкетирование.ТаблицаДоступныхРеспондентуАнкет(Респондент);
	Если НЕ (ПолученнаяТаблицаАнкет = Неопределено) Тогда
		Для Каждого СтрокаТаблицы Из ПолученнаяТаблицаАнкет Цикл
			НоваяСтрока = ТаблицаАнкет.Добавить();
			Если НЕ ЗначениеЗаполнено(СтрокаТаблицы.АнкетаОпрос) Тогда
				НоваяСтрока.Представление = СтрокаТаблицы.Статус;
				НоваяСтрока.Статус        = СтрокаТаблицы.Статус;
			Иначе
				НоваяСтрока.Статус        = СтрокаТаблицы.Статус;
				НоваяСтрока.АнкетаОпрос   = СтрокаТаблицы.АнкетаОпрос;
				НоваяСтрока.Представление = CRM_МетодыФормДокументовСервер.ПолучитьПредставлениеСтрокиДереваАнкеты(СтрокаТаблицы);
			КонецЕсли;
		КонецЦикла;
		НоваяСтрока.КодКартинки = ?(СтрокаТаблицы.Статус = "Опросы", 0, 1);
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура CRM_ПриЗагрузкеДанныхИзНастроекНаСервере(Настройки)
	
	Если НЕ ПризнакФормаОткрытаПоПартнеру Тогда
		СохраненныйОтборРеспондент = Настройки.Получить("ПолеБыстрогоОтбора_Респондент");
		Если ЗначениеЗаполнено(Респондент) Тогда
			CRM_ОбщегоНазначенияКлиентСервер.ИзменитьЭлементОтбораСписка(Список, "Респондент", Респондент, Истина);
		КонецЕсли;
		ДокументПроведен = Настройки.Получить("ПолеБыстрогоОтбора_Проведен");
		Если ЗначениеЗаполнено(ДокументПроведен) Тогда
			Если ДокументПроведен = "Завершенные" Тогда
				CRM_ОбщегоНазначенияКлиентСервер.ИзменитьЭлементОтбораСписка(Список, "Проведен", Истина, Истина, ВидСравненияКомпоновкиДанных.Равно);
			ИначеЕсли ДокументПроведен = "Незавершенные" Тогда
				CRM_ОбщегоНазначенияКлиентСервер.ИзменитьЭлементОтбораСписка(Список, "Проведен", Ложь, Истина, ВидСравненияКомпоновкиДанных.Равно);
			КонецЕсли;
		КонецЕсли;	
	КонецЕсли; 
	
КонецПроцедуры

&НаСервере
Процедура CRM_КомандаВидСпискаСервер(СвойстваДинамическогоСписка, ПризнакИзмененыНастройки)
	
	CRM_ОбщегоНазначенияКлиентСервер.ОбработкаКомандыПользовательскихНастроекДинамическогоСписка(ЭтотОбъект, СвойстваДинамическогоСписка, ПризнакИзмененыНастройки);
	
КонецПроцедуры

&НаСервере
Функция CRM_ПолучитьСвойстваДинамическогоСпискаСервер()
	
	Возврат CRM_ОбщегоНазначенияСервер.ПолучитьСвойстваДинамическогоСписка(	ЭтотОбъект, "Список", 
		?(ПризнакФормаОткрытаПоПартнеру, "Документ.Анкета.ПоПартнеру", "Документ.Анкета"), Неопределено, Неопределено,
		Неопределено, "ПодменюВидСписка", "ВидСпискаИдентификаторТекущейНастройки","CRM_Подключаемый_КомандаВидСписка");
	
КонецФункции

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	// +Пользовательские настройки.
	ДобавитьПодменюПользовательскихНастроек();
	// -Пользовательские настройки.
КонецПроцедуры


#Область ПользовательскиеНастройки

&НаСервере
Процедура ДобавитьПодменюПользовательскихНастроек()
	CRM_ПользовательскиеНастройкиСервер.УстановитьПользовательскиеНастройки(Список, ИдентификаторПользовательскойНастройки, ИмяФормы+".Список");
	CRM_ПользовательскиеНастройкиСервер.ДобавитьПодменюПользовательскихНастроек(ЭтотОбъект, Список, ИмяФормы+".Список");
КонецПроцедуры

&НаСервере
Процедура ОбработатьВыборНастройкиНаСервере(НомерНастройки)
	CRM_ПользовательскиеНастройкиСервер.ОбработатьВыборНастройкиНаСервере(НомерНастройки, Список, ЭтотОбъект, ИмяФормы+".Список");	
КонецПроцедуры


&НаКлиенте
Процедура ОбработатьВыборНастройки(Команда)
	НомерНастройкиСтрока = СтрЗаменить(Команда.Имя, "ОбработатьВыборНастройки_", "");
	НомерНастройки = Число(НомерНастройкиСтрока);
	 ОбработатьВыборНастройкиНаСервере(НомерНастройки);	
КонецПроцедуры

&НаСервере
Процедура СохранитьТекущиеНастройкиНаСервере(ИмяНастройки, ДополнительныеПараметры) Экспорт
	Если НЕ ИмяНастройки = Неопределено Тогда
		CRM_ПользовательскиеНастройкиСервер.СохранитьТекущиеНастройкиНаСервере(ИмяНастройки, Список, ЭтотОбъект, ИмяФормы+".Список");
	КонецЕсли;	
КонецПроцедуры

&НаКлиенте
Процедура СохранитьТекущиеНастройки(Команда)
	ПараметрыОповещения = Новый Структура;
	Оповещение = Новый ОписаниеОповещения("СохранитьТекущиеНастройкиНаСервере", ЭтотОбъект, ПараметрыОповещения);
	ПоказатьВводСтроки(Оповещение, "", "Введите название настройки");		
КонецПроцедуры

&НаСервере
Процедура УдалитьНастройкуНаСервере()
	ПредставлениеНастройки = CRM_ПользовательскиеНастройкиСервер.ПолучитьПредставлениеНастройки(ИдентификаторПользовательскойНастройки, ИмяФормы+".Список");	
	ХранилищеПользовательскихНастроекДинамическихСписков.Удалить(ИмяФормы+".Список", ИдентификаторПользовательскойНастройки, ИмяПользователя()); 
	ИдентификаторПользовательскойНастройки = "Стандартные_Настройки";
	CRM_ПользовательскиеНастройкиСервер.УстановитьПользовательскиеНастройки(Список, ИдентификаторПользовательскойНастройки, ИмяФормы+".Список");
	CRM_ПользовательскиеНастройкиСервер.ДобавитьПодменюПользовательскихНастроек(ЭтотОбъект, Список, ИмяФормы+".Список");
		
КонецПроцедуры	

&НаКлиенте
Процедура ОбработкаОтветаУдаление(ВариантОтвета, ДополнительныеПараметры) Экспорт
	Если ВариантОтвета = КодВозвратаДиалога.Да Тогда
		УдалитьНастройкуНаСервере();
	КонецЕсли;	
КонецПроцедуры

&НаКлиенте
Процедура УдалитьТекущуюНастройку(Команда)
	Если ИдентификаторПользовательскойНастройки = "Стандартные_Настройки" Тогда
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Нельзя удалить стандартные настройки";
		Сообщение.Сообщить();
	Иначе
		ПараметрыОповещения = Новый Структура;
		Оповещение = Новый ОписаниеОповещения("ОбработкаОтветаУдаление", ЭтотОбъект, ПараметрыОповещения);
		ПоказатьВопрос(Оповещение, "Вы действительно хотите удалить настройку """+CRM_ПользовательскиеНастройкиСервер.ПолучитьПредставлениеНастройки(ИдентификаторПользовательскойНастройки, ИмяФормы+".Список")+""" ?", РежимДиалогаВопрос.ДаНет);
		
	КонецЕсли;	
	
КонецПроцедуры

#КонецОбласти



// -CRM