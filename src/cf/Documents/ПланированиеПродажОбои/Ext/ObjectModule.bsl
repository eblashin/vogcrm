
Процедура ОбработкаПроведения(Отказ, РежимПроведения)
	
	Запрос = Новый Запрос;
	Если СценарийПланирования = Справочники.вогСценарииПланирования.ПланНаКвартал тогда
		Запрос.Текст = "ВЫБРАТЬ
		               |	ПланированиеПродажОбоиДанныеПланирования.Ссылка КАК Ссылка,
		               |	ПланированиеПродажОбоиДанныеПланирования.ТорговаяТочка КАК ТорговаяТочка,
		               |	ПланированиеПродажОбоиДанныеПланирования.КоличествоПолок106 КАК КоличествоПолок1,
		               |	ПланированиеПродажОбоиДанныеПланирования.КоличествоПолок05 КАК КоличествоПолок05,
		               |	ПланированиеПродажОбоиДанныеПланирования.Оборот106 КАК ОборотСПолки1,
		               |	ПланированиеПродажОбоиДанныеПланирования.Оборот05 КАК ОборотСПолки05,
		               |	ПланированиеПродажОбоиДанныеПланирования.КоличествоSKUПереоценка106 КАК КоличествоSKUПереоценка1,
		               |	ПланированиеПродажОбоиДанныеПланирования.КоличествоSKUПереоценка05 КАК КоличествоSKUПереоценка05,
		               |	ПланированиеПродажОбоиДанныеПланирования.Переоценка106 КАК Переоценка1,
		               |	ПланированиеПродажОбоиДанныеПланирования.Переоценка05 КАК Переоценка05,
		               |	ПланированиеПродажОбоиДанныеПланирования.Корректировка КАК КорректировкаПлана1,
		               |	ПланированиеПродажОбоиДанныеПланирования.Распродажа КАК Распродажа,
		               |	ПланированиеПродажОбоиДанныеПланирования.План КАК План1,
		               |	ПланированиеПродажОбоиДанныеПланирования.Ссылка.Дата КАК период,
		               |	ПланированиеПродажОбоиДанныеПланирования.Ссылка.Автор КАК Автор,
		               |	ПланированиеПродажОбоиДанныеПланирования.Ссылка.СценарийПланирования КАК Сценарий,
		               |	ПланированиеПродажОбоиДанныеПланирования.Ссылка.ВерсияСценария КАК Версия,
		               |	ПланированиеПродажОбоиДанныеПланирования.Ссылка.ПериодПланирования КАК ПериодПланирования,
					   // +++ VOG Кулаков П.Л. 18.03.2021 DEV-273
		               |	ВЫБОР
		               |		КОГДА ПланированиеПродажОбоиДанныеПланирования.ТорговаяТочка ССЫЛКА Справочник.вогТорговыеТочки 
					   |				И ПланированиеПродажОбоиДанныеПланирования.ТорговаяТочка <> Значение(Справочник.вогТорговыеТочки.)
		               |			ТОГДА ПланированиеПродажОбоиДанныеПланирования.ТорговаяТочка.НаселенныйПункт
		               |		ИНАЧЕ ПланированиеПродажОбоиДанныеПланирования.Город
		               |	КОНЕЦ КАК Город,
					   // --- VOG Кулаков П.Л.
		               |	0 КАК Месяц,
		               |	ПланированиеПродажОбоиДанныеПланирования.ВидПотенциальнойТТ КАК ВидПотенциальнойТорговойТочки,
		               |	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.) КАК Подразделение,
		               |	ПланированиеПродажОбоиДанныеПланирования.Клиент КАК Клиент,
		               |	ПланированиеПродажОбоиДанныеПланирования.МаркетингIndoor КАК МаркетингIndoor,
		               |	ПланированиеПродажОбоиДанныеПланирования.МаркетингOutdoor КАК МаркетингOutdoor,
		               |	ПланированиеПродажОбоиДанныеПланирования.Акции КАК Акции,
		               |	ПланированиеПродажОбоиДанныеПланирования.Образцы КАК Образцы,
		               |	ПланированиеПродажОбоиДанныеПланирования.Корзины КАК Корзины,
					   // +++ VOG Кулаков П.Л. 25.05.2021 DEV-573
					   |	ПланированиеПродажОбоиДанныеПланирования.МаркетингIndoorСвыше100 КАК МаркетингIndoorСвыше100,
					   |	ПланированиеПродажОбоиДанныеПланирования.Представительские КАК Представительские,
					   |	ПланированиеПродажОбоиДанныеПланирования.ПрочийМаркетинг КАК ПрочийМаркетинг,
					   |	ПланированиеПродажОбоиДанныеПланирования.СтоимостьУценки1 КАК СтоимостьУценки1,
					   |	ПланированиеПродажОбоиДанныеПланирования.СтоимостьУценки05 КАК СтоимостьУценки05,
					   |	ПланированиеПродажОбоиДанныеПланирования.Цена1 КАК Цена1,
					   |	ПланированиеПродажОбоиДанныеПланирования.Цена05 КАК Цена05,
					   |	ПланированиеПродажОбоиДанныеПланирования.СтоимостьРаспродажа КАК СтоимостьРаспродажа
					   // --- VOG Кулаков П.Л.
		               |ИЗ
		               |	Документ.ПланированиеПродажОбои.ДанныеПланированияКвартал КАК ПланированиеПродажОбоиДанныеПланирования
		               |ГДЕ
		               |	ПланированиеПродажОбоиДанныеПланирования.Ссылка = &Ссылка";
		
		
		
	Иначе
		Запрос.Текст = "ВЫБРАТЬ
		|	ПланированиеПродажОбоиДанныеПланирования.Ссылка КАК Ссылка,
		|	ПланированиеПродажОбоиДанныеПланирования.ТорговаяТочка КАК ТорговаяТочка,
		|	ПланированиеПродажОбоиДанныеПланирования.КоличествоПолок1 КАК КоличествоПолок1,
		|	ПланированиеПродажОбоиДанныеПланирования.КоличествоПолок05 КАК КоличествоПолок05,
		|	ПланированиеПродажОбоиДанныеПланирования.ОборотСПолки1 КАК ОборотСПолки1,
		|	ПланированиеПродажОбоиДанныеПланирования.ОборотСПолки05 КАК ОборотСПолки05,
		|	ПланированиеПродажОбоиДанныеПланирования.КорректировкаПлана1 КАК КорректировкаПлана1,
		|	ПланированиеПродажОбоиДанныеПланирования.КорректировкаПланаДТН1 КАК КорректировкаПланаДТН1,
		|	ПланированиеПродажОбоиДанныеПланирования.План1 КАК План1,
		|	ПланированиеПродажОбоиДанныеПланирования.Комментарий КАК Комментарий,
		|	ПланированиеПродажОбоиДанныеПланирования.Ссылка.Дата КАК период,
		|	ПланированиеПродажОбоиДанныеПланирования.Ссылка.Автор КАК Автор,
		|	ПланированиеПродажОбоиДанныеПланирования.Ссылка.СценарийПланирования КАК Сценарий,
		|	ПланированиеПродажОбоиДанныеПланирования.Ссылка.ВерсияСценария КАК Версия,
		|	ПланированиеПродажОбоиДанныеПланирования.Ссылка.ПериодПланирования КАК ПериодПланирования,
		|	ПланированиеПродажОбоиДанныеПланирования.ТорговаяТочка.НаселенныйПункт КАК Город,
		|	0 КАК Месяц,
		|	ПланированиеПродажОбоиДанныеПланирования.ВидПотенциальнойТорговойТочки КАК ВидПотенциальнойТорговойТочки,
		|	NULL КАК Подразделение,
		|	NULL КАК Клиент
		|ИЗ
		|	Документ.ПланированиеПродажОбои.ДанныеПланирования КАК ПланированиеПродажОбоиДанныеПланирования
		|ГДЕ
		|	ПланированиеПродажОбоиДанныеПланирования.Ссылка = &Ссылка
		|	И ПланированиеПродажОбоиДанныеПланирования.ТорговаяТочка ССЫЛКА Справочник.вогТорговыеТочки
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ПланированиеПродажОбоиДанныеПланирования.Ссылка,
		|	ПланированиеПродажОбоиДанныеПланирования.ТорговаяТочка,
		|	ПланированиеПродажОбоиДанныеПланирования.КоличествоПолок1,
		|	0,
		|	ПланированиеПродажОбоиДанныеПланирования.ОборотСПолки1,
		|	0,
		|	ПланированиеПродажОбоиДанныеПланирования.КорректировкаПлана1,
		|	ПланированиеПродажОбоиДанныеПланирования.КорректировкаПланаДТН1,
		|	ПланированиеПродажОбоиДанныеПланирования.План1,
		|	ПланированиеПродажОбоиДанныеПланирования.Комментарий,
		|	ПланированиеПродажОбоиДанныеПланирования.Ссылка.Дата,
		|	ДанныеПланированияПродажОбои.Автор,
		|	ПланированиеПродажОбоиДанныеПланирования.Ссылка.СценарийПланирования,
		|	ПланированиеПродажОбоиДанныеПланирования.Ссылка.ВерсияСценария,
		|	ПланированиеПродажОбоиДанныеПланирования.Ссылка.ПериодПланирования,
		|	ДанныеПланированияПродажОбои.Город,
		|	ДанныеПланированияПродажОбои.Месяц,
		|	ДанныеПланированияПродажОбои.ВидПотенциальнойТорговойТочки,
		|	ДанныеПланированияПродажОбои.Подразделение,
		|	ДанныеПланированияПродажОбои.Клиент
		|ИЗ
		|	РегистрСведений.ДанныеПланированияПродажОбои КАК ДанныеПланированияПродажОбои
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ПланированиеПродажОбои.ДанныеПланирования КАК ПланированиеПродажОбоиДанныеПланирования
		|		ПО ДанныеПланированияПродажОбои.ТорговаяТочка = ПланированиеПродажОбоиДанныеПланирования.ТорговаяТочка
		|			И (ДанныеПланированияПродажОбои.Регистратор ССЫЛКА Документ.ПланированиеПродажПоПотенциальнымТорговымТочкамОбои)
		|ГДЕ
		|	ПланированиеПродажОбоиДанныеПланирования.Ссылка = &Ссылка
		|	И НЕ ПланированиеПродажОбоиДанныеПланирования.ТорговаяТочка ССЫЛКА Справочник.вогТорговыеТочки";
	КонецЕсли;
	Запрос.УстановитьПараметр("Ссылка",Ссылка);
	Движения.ДанныеПланированияПродажОбои.Загрузить(Запрос.Выполнить().Выгрузить());
	Движения.ДанныеПланированияПродажОбои.Записывать = Истина;
	
	// +++ VOG Кулаков П.Л. 26.03.2021
	ПодразделениеДекорК = Справочники.СтруктураПредприятия.ПолучитьСсылку(Новый УникальныйИдентификатор("fcf03b76-6579-11e7-9071-005056acd97c"));
	ПодразделениеКубань = Справочники.СтруктураПредприятия.ПолучитьСсылку(Новый УникальныйИдентификатор("eb3f3e9a-66e5-11e3-9235-00155d66c603"));
	ПодразделениеКМВ = Справочники.СтруктураПредприятия.ПолучитьСсылку(Новый УникальныйИдентификатор("3000815c-66e6-11e3-9235-00155d66c603"));
	ПодразделениеРостов = Справочники.СтруктураПредприятия.ПолучитьСсылку(Новый УникальныйИдентификатор("9f82aafb-3b61-11e9-b0ca-005056bcd3e3"));
	// --- VOG Кулаков П.Л.
	
	Для каждого Запись из Движения.ДанныеПланированияПродажОбои цикл
		
		// +++ VOG Кулаков П.Л. 26.03.2021
		Запись.Подразделение = Справочники.СтруктураПредприятия.ПолучитьОбособленноеПодразделение(Запись.Автор.Подразделение);
		Если Запись.Подразделение = ПодразделениеДекорК ИЛИ Запись.Подразделение = ПодразделениеКубань 
			ИЛИ Запись.Подразделение = ПодразделениеКМВ ИЛИ Запись.Подразделение = ПодразделениеРостов Тогда 
			ПодразделениеТорговойТочки = РегистрыСведений.ПодразделенияТорговыхТочек.ПолучитьПодразделениеТорговойТочки(Запись.ТорговаяТочка,Справочники.НаправленияДеятельности.Обои);
			Если ПодразделениеТорговойТочки <> Неопределено Тогда
				Запись.Подразделение = ПодразделениеТорговойТочки;
			КонецЕсли;
		КонецЕсли;
		// --- VOG Кулаков П.Л.
		
	КонецЦикла;
	Если СценарийПланирования = Справочники.вогСценарииПланирования.ПланНаКвартал тогда
		Запрос.Текст = "ВЫБРАТЬ
		               |	ПланированиеПродажОбоиКомментарии.Владелец КАК ТорговаяТочка,
		               |	ВЫБОР
		               |		КОГДА ПланированиеПродажОбоиКомментарии.Владелец ССЫЛКА Справочник.вогТорговыеТочки
		               |				И ПланированиеПродажОбоиКомментарии.Владелец <> ЗНАЧЕНИЕ(Справочник.вогТорговыеТочки.)
		               |			ТОГДА ПланированиеПродажОбоиКомментарии.Владелец.Партнер
		               |		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.Партнеры.)
		               |	КОНЕЦ КАК Клиент,
		               |	ПланированиеПродажОбоиКомментарии.Комментарий КАК Комментарий,
		               |	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.Обои) КАК НаправлениеДеятельности,
		               |	ПланированиеПродажОбоиКомментарии.Ссылка.СценарийПланирования КАК СценарийПланирования,
		               |	ПланированиеПродажОбоиКомментарии.Ссылка.ВерсияСценария КАК ВерсияСценария,
		               |	ПланированиеПродажОбоиКомментарии.Ссылка.Дата КАК Период,
		               |	ПланированиеПродажОбоиКомментарии.ВидПотенциальнойТТ КАК ВидПотенциальнойТТ,
					   // +++ VOG Кулаков П.Л. 09.06.2021 DEV-605
		               |	ПланированиеПродажОбоиКомментарии.Ссылка.ПериодПланирования КАК ПериодПланирования
					   // --- VOG Кулаков П.Л. 
		               |ИЗ
		               |	Документ.ПланированиеПродажОбои.Комментарии КАК ПланированиеПродажОбоиКомментарии
		               |ГДЕ
		               |	ПланированиеПродажОбоиКомментарии.Ссылка = &Ссылка
		               |	И НЕ ПланированиеПродажОбоиКомментарии.Владелец ССЫЛКА Справочник.Партнеры
		               |
		               |ОБЪЕДИНИТЬ ВСЕ
		               |
		               |ВЫБРАТЬ
		               |	ЗНАЧЕНИЕ(Справочник.вогТорговыеТочки.),
		               |	ПланированиеПродажОбоиКомментарии.Владелец,
		               |	ПланированиеПродажОбоиКомментарии.Комментарий,
		               |	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.Обои),
		               |	ПланированиеПродажОбоиКомментарии.Ссылка.СценарийПланирования,
		               |	ПланированиеПродажОбоиКомментарии.Ссылка.ВерсияСценария,
		               |	ПланированиеПродажОбоиКомментарии.Ссылка.Дата,
		               |	ПланированиеПродажОбоиКомментарии.ВидПотенциальнойТТ,
					   // +++ VOG Кулаков П.Л. 09.06.2021 DEV-605
		               |	ПланированиеПродажОбоиКомментарии.Ссылка.ПериодПланирования
					   // --- VOG Кулаков П.Л.
		               |ИЗ
		               |	Документ.ПланированиеПродажОбои.Комментарии КАК ПланированиеПродажОбоиКомментарии
		               |ГДЕ
		               |	ПланированиеПродажОбоиКомментарии.Ссылка = &Ссылка
		               |	И ПланированиеПродажОбоиКомментарии.Владелец ССЫЛКА Справочник.Партнеры";
		
		Движения.КомментарииКПланированиюПродажПлитка.Загрузить(Запрос.Выполнить().Выгрузить());
		// +++ VOG Кулаков П.Л. 09.06.2021 DEV-605
		Для каждого Запись из Движения.КомментарииКПланированиюПродажПлитка цикл
			Запись.Подразделение = Справочники.СтруктураПредприятия.ПолучитьОбособленноеПодразделение(Автор.Подразделение);
			Если Запись.Подразделение = ПодразделениеДекорК ИЛИ Запись.Подразделение = ПодразделениеКубань 
				ИЛИ Запись.Подразделение = ПодразделениеКМВ ИЛИ Запись.Подразделение = ПодразделениеРостов Тогда 
				ПодразделениеТорговойТочки = РегистрыСведений.ПодразделенияТорговыхТочек.ПолучитьПодразделениеТорговойТочки(Запись.ТорговаяТочка,Справочники.НаправленияДеятельности.Обои);
				Если ПодразделениеТорговойТочки <> Неопределено Тогда
					Запись.Подразделение = ПодразделениеТорговойТочки;
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
		// --- VOG Кулаков П.Л.
		Движения.КомментарииКПланированиюПродажПлитка.Записывать = Истина;
		Запрос.Текст = "ВЫБРАТЬ
		               |	ПланированиеПродажОбоиКомандировки.Владелец КАК Торговаяточка,
		               |	ВЫБОР
		               |		КОГДА ПланированиеПродажОбоиКомандировки.Владелец ССЫЛКА Справочник.вогТорговыеТочки
					   |				И ПланированиеПродажОбоиКомандировки.Владелец <> Значение(Справочник.вогТорговыеТочки.)
		               |			ТОГДА ПланированиеПродажОбоиКомандировки.Владелец.Партнер
		               |		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.Партнеры.)
		               |	КОНЕЦ КАК Партнер,
		               |	ПланированиеПродажОбоиКомандировки.КомандировкаМесяц1 КАК Количество1Месяц,
		               |	ПланированиеПродажОбоиКомандировки.КомандировкаМесяц2 КАК Количество2Месяц,
		               |	ПланированиеПродажОбоиКомандировки.КомандировкаМесяц3 КАК Количество3Месяц,
		               |	ПланированиеПродажОбоиКомандировки.ЗадачиПоДостижениюЦели КАК ЗадачиПоДостижениюЦели,
		               |	ПланированиеПродажОбоиКомандировки.Ссылка.ПериодПланирования КАК ПериодПланирования,
		               |	ПланированиеПродажОбоиКомандировки.Ссылка.СценарийПланирования КАК СценарийПланирования,
		               |	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.Обои) КАК НаправлениеДеятельности,
		               |	ПланированиеПродажОбоиКомандировки.Ссылка.ВерсияСценария КАК Версия,
		               |	ПланированиеПродажОбоиКомандировки.Ссылка.Дата КАК Период,
		               |	ПланированиеПродажОбоиКомандировки.ВидПотенциальнойТТ КАК ВидПотенциальнойТорговойТочки
		               |ИЗ
		               |	Документ.ПланированиеПродажОбои.Командировки КАК ПланированиеПродажОбоиКомандировки
		               |ГДЕ
		               |	НЕ ПланированиеПродажОбоиКомандировки.Владелец ССЫЛКА Справочник.Партнеры
		               |	И ПланированиеПродажОбоиКомандировки.Ссылка = &Ссылка
		               |
		               |ОБЪЕДИНИТЬ ВСЕ
		               |
		               |ВЫБРАТЬ
		               |	ЗНАЧЕНИЕ(Справочник.вогТорговыеТочки.),
		               |	ПланированиеПродажОбоиКомандировки.Владелец,
		               |	ПланированиеПродажОбоиКомандировки.КомандировкаМесяц1,
		               |	ПланированиеПродажОбоиКомандировки.КомандировкаМесяц2,
		               |	ПланированиеПродажОбоиКомандировки.КомандировкаМесяц3,
		               |	ПланированиеПродажОбоиКомандировки.ЗадачиПоДостижениюЦели,
		               |	ПланированиеПродажОбоиКомандировки.Ссылка.ПериодПланирования,
		               |	ПланированиеПродажОбоиКомандировки.Ссылка.СценарийПланирования,
		               |	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.Обои),
		               |	ПланированиеПродажОбоиКомандировки.Ссылка.ВерсияСценария,
		               |	ПланированиеПродажОбоиКомандировки.Ссылка.Дата,
		               |	ПланированиеПродажОбоиКомандировки.ВидПотенциальнойТТ
		               |ИЗ
		               |	Документ.ПланированиеПродажОбои.Командировки КАК ПланированиеПродажОбоиКомандировки
		               |ГДЕ
		               |	ПланированиеПродажОбоиКомандировки.Владелец ССЫЛКА Справочник.Партнеры
		               |	И ПланированиеПродажОбоиКомандировки.Ссылка = &Ссылка";
		
		Движения.ПланированиеПосещений.Загрузить(Запрос.Выполнить().Выгрузить());
		Движения.ПланированиеПосещений.Записывать = Истина;
		
	КонецЕсли;
	//ВерсияСценарияНаВесьГод = Справочники.вогВерсииСценариевПланирования.НайтиПоНаименованию("Основная",,,Справочники.вогСценарииПланирования.ПланНаЦелыйГод);
	//
	//
	//Если ПланУтверждён тогда
	//	
	//	Движения.ПланыПродаж.Записывать = Истина;
	//	Движения.ПланыПродаж.Очистить();
	//	Для каждого Запись из Движения.ДанныеПланированияПродажОбои цикл
	//		НоваяЗапись = Движения.ПланыПродаж.Добавить();
	//		ЗаполнитьЗначенияСвойств(НоваяЗапись,Запись);
	//		Если Запись.Сценарий = Справочники.вогСценарииПланирования.ПланНаГод тогда
	//			НоваяЗапись.СценарийПланирования = Справочники.вогСценарииПланирования.ПланНаЦелыйГод;
	//			НоваяЗапись.ВерсияСценария = ВерсияСценарияНаВесьГод;
	//		Иначе
	//			НоваяЗапись.СценарийПланирования = Запись.Сценарий;
	//			НоваяЗапись.ВерсияСценария = Запись.Версия;
	//		КонецЕсли;
	//		НоваяЗапись.Период = Запись.ПериодПланирования;
	//		НоваяЗапись.ТРТ = Запись.ТорговаяТочка;
	//		НоваяЗапись.Партнер = Запись.Клиент;
	//		НоваяЗапись.НаправлениеДеятельности = Справочники.НаправленияДеятельности.Обои;
	//		НоваяЗапись.КоличествоНашихSKU053 = Запись.КоличествоПолок05;
	//		НоваяЗапись.КоличествоНашихSKU106 = Запись.КоличествоПолок1;
	//		НоваяЗапись.ОборотСПолки053 = Запись.ОборотСПолки05;
	//		НоваяЗапись.ОборотСПолки106 = Запись.ОборотСПолки1;
	//		НоваяЗапись.КорректировкаПлана = Запись.КорректировкаПлана1;
	//		НоваяЗапись.Количество = Запись.План1;
	//		
	//	КонецЦикла;
	//	
	//	
	//КонецЕсли;
	
	
КонецПроцедуры

Процедура ОбработкаПроверкиЗаполнения(Отказ, ПроверяемыеРеквизиты)
	
	Для каждого Строка из ДанныеПланирования цикл
		
		Если Строка.ВидПотенциальнойТорговойТочки = Перечисления.ВидыПотенциальнойТорговойТочки.Магазин_Палитра_ваших_стен или
			Строка.ВидПотенциальнойТорговойТочки = Перечисления.ВидыПотенциальнойТорговойТочки.Магазин_Палитра_Плюс или
			Строка.ВидПотенциальнойТорговойТочки = Перечисления.ВидыПотенциальнойТорговойТочки.Новый_магазин_клиента_без_бренд_зоны тогда
			Если Не ЗначениеЗаполнено(Строка.Город) тогда
				Отказ = Истина;
			КонецЕсли;
		КонецЕсли;
		
		Если строка.ВидПотенциальнойТорговойТочки = Перечисления.ВидыПотенциальнойТорговойТочки.НоваяБрендЗонаВСуществующейТТ тогда
			Если Не ЗначениеЗаполнено(Строка.ТорговаяТочка) тогда
				Отказ = Истина;
			КонецЕсли;
		КонецЕсли;
		
	КонецЦикла;
	
	
КонецПроцедуры
