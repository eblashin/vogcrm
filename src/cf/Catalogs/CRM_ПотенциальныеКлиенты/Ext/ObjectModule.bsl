#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

Процедура ПередЗаписью(Отказ)
	
	ОтборТелефон = Новый Структура("Тип, CRM_ОсновнойДляСвязи", Перечисления.ТипыКонтактнойИнформации.Телефон, Истина);
	ОтборЭП		 = Новый Структура("Тип, CRM_ОсновнойДляСвязи", Перечисления.ТипыКонтактнойИнформации.АдресЭлектроннойПочты, Истина);
	ЕстьОсновнойТелефон = (КонтактнаяИнформация.НайтиСтроки(ОтборТелефон).Количество() > 0);
	ЕстьОсновнойАдресЭП	= (КонтактнаяИнформация.НайтиСтроки(ОтборЭП).Количество() > 0);
	
	Если НЕ ЕстьОсновнойТелефон Тогда
		ОтборТелефон.Удалить("CRM_ОсновнойДляСвязи");
		СтрокиТелефон = КонтактнаяИнформация.НайтиСтроки(ОтборТелефон);
		
		Если СтрокиТелефон.Количество() > 0 Тогда
			ОсновнойТелефонСтрока = СтрокиТелефон[0];
			Для Каждого СтрокаТ Из СтрокиТелефон Цикл
				Если СтрокаТ.Вид.Предопределенный Тогда
					ОсновнойТелефонСтрока = СтрокаТ;
				КонецЕсли;
			КонецЦикла;
			ОсновнойТелефонСтрока.CRM_ОсновнойДляСвязи = Истина;
		КонецЕсли;
	КонецЕсли;
	
	Если НЕ ЕстьОсновнойАдресЭП Тогда
		ОтборЭП.Удалить("CRM_ОсновнойДляСвязи");
		СтрокиЭП = КонтактнаяИнформация.НайтиСтроки(ОтборЭП);
		
		Если СтрокиЭП.Количество() > 0 Тогда
			ОсновнойАдресЭПСтрока = СтрокиЭП[0];
			Для Каждого СтрокаЭП Из СтрокиЭП Цикл
				Если СтрокаЭП.Вид.Предопределенный Тогда
					ОсновнойАдресЭПСтрока = СтрокаЭП;
				КонецЕсли;
			КонецЦикла;
			ОсновнойАдресЭПСтрока.CRM_ОсновнойДляСвязи = Истина;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

Процедура ОбработкаЗаполнения(ДанныеЗаполнения, ТекстЗаполнения, СтандартнаяОбработка)
	Если ТипЗнч(ДанныеЗаполнения) = Тип("ДокументСсылка.ТелефонныйЗвонок") Тогда
		СтруктураНомера	= сфпСофтФонПроСервер.сфпЗаполнитьСтруктуруПолейПоПредставлениюТелефон(ДанныеЗаполнения.АбонентКакСвязаться);
		Телефон = сфпСофтФонПроСервер.сфпУбратьИзНомераТелефонаВсеПрефиксы(ДанныеЗаполнения.АбонентКакСвязаться);		
		Наименование = ДанныеЗаполнения.АбонентПредставление;
		НоваяКИ = КонтактнаяИнформация.Добавить();
		НоваяКИ.Тип = ПредопределенноеЗначение("Перечисление.ТипыКонтактнойИнформации.Телефон");
		СтруктураНомера = сфпСофтФонПроСервер.сфпЗаполнитьСтруктуруПолейПоПредставлениюТелефон(Телефон);
		НоваяКИ.Вид = ПредопределенноеЗначение("Справочник.ВидыКонтактнойИнформации.CRM_ТелефонПотенциальногоКлиента");
		НоваяКИ.НомерТелефонаБезКодов	= СтруктураНомера.НомерТелефона;		
		Если ЗначениеЗаполнено(СтруктураНомера.КодГорода) Тогда
			НоваяКИ.Представление	= ?(ЗначениеЗаполнено(СтруктураНомера.КодСтраны),СтруктураНомера.КодСтраны + " (", "(") + СтруктураНомера.КодГорода + ") " + СтруктураНомера.НомерТелефона;
		Иначе	
			НоваяКИ.Представление	= Телефон;
		КонецЕсли;	
		НоваяКИ.НомерТелефона = Телефон;
		ЗначенияПолей	= Новый СписокЗначений;
		ЗначенияПолей.Добавить(СтруктураНомера.КодСтраны,		"КодСтраны");
		ЗначенияПолей.Добавить(СтруктураНомера.КодГорода,		"КодГорода");
		ЗначенияПолей.Добавить(СтруктураНомера.НомерТелефона,	"НомерТелефона");
		НоваяКИ.ЗначенияПолей	= ЗначенияПолей;				
	ИначеЕсли ТипЗнч(ДанныеЗаполнения) = Тип("Структура") И ДанныеЗаполнения.Свойство("Телефон") Тогда
		СтруктураНомера	= сфпСофтФонПроСервер.сфпЗаполнитьСтруктуруПолейПоПредставлениюТелефон(ДанныеЗаполнения.Телефон);
		Телефон = сфпСофтФонПроСервер.сфпУбратьИзНомераТелефонаВсеПрефиксы(ДанныеЗаполнения.Телефон);		
		НоваяКИ = КонтактнаяИнформация.Добавить();
		НоваяКИ.Тип = ПредопределенноеЗначение("Перечисление.ТипыКонтактнойИнформации.Телефон");
		СтруктураНомера = сфпСофтФонПроСервер.сфпЗаполнитьСтруктуруПолейПоПредставлениюТелефон(Телефон);
		НоваяКИ.Вид = ПредопределенноеЗначение("Справочник.ВидыКонтактнойИнформации.CRM_ТелефонПотенциальногоКлиента");
		НоваяКИ.НомерТелефонаБезКодов	= СтруктураНомера.НомерТелефона;		
		Если ЗначениеЗаполнено(СтруктураНомера.КодГорода) Тогда
			НоваяКИ.Представление	= ?(ЗначениеЗаполнено(СтруктураНомера.КодСтраны),СтруктураНомера.КодСтраны + " (", "(") + СтруктураНомера.КодГорода + ") " + СтруктураНомера.НомерТелефона;
		Иначе	
			НоваяКИ.Представление	= Телефон;
		КонецЕсли;	
		НоваяКИ.НомерТелефона = Телефон;
		ЗначенияПолей	= Новый СписокЗначений;
		ЗначенияПолей.Добавить(СтруктураНомера.КодСтраны,		"КодСтраны");
		ЗначенияПолей.Добавить(СтруктураНомера.КодГорода,		"КодГорода");
		ЗначенияПолей.Добавить(СтруктураНомера.НомерТелефона,	"НомерТелефона");
		НоваяКИ.ЗначенияПолей	= ЗначенияПолей;				
	КонецЕсли;		
КонецПроцедуры	

#КонецЕсли
