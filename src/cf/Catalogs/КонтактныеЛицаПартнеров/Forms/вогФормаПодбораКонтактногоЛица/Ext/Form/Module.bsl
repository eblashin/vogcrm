
// ++ Тищенко В.В. 01.04.2019

#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Если НЕ Параметры.Свойство("ОбъектСвязи") Тогда
		ТекстСообщения = НСтр("ru = 'Не установлен отбор по объекту связи.'");
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
	КонецЕсли;
	
	ОбщегоНазначенияКлиентСервер.УстановитьПараметрДинамическогоСписка(Список,"ОбъектСвязи",Параметры.ОбъектСвязи);
	
	// +++ VOG Кулаков П.Л. 03.03.2020 CRM-412
	// Добавим партнера в дополнительные свойства динамического списка для дальнейшей обработки
	Список.КомпоновщикНастроек.Настройки.ДополнительныеСвойства.Вставить("ОбъектСвязи",Параметры.ОбъектСвязи);
	// --- VOG Кулаков П.Л.
	
КонецПроцедуры

// +++ VOG Кулаков П.Л. 03.03.2020 CRM-412
&НаСервереБезКонтекста
Процедура СписокПриПолученииДанныхНаСервере(ИмяЭлемента, Настройки, Строки)
	
	ОбъектСвязи = Неопределено;
	Настройки.ДополнительныеСвойства.Свойство("ОбъектСвязи",ОбъектСвязи);
	Запрос = Новый Запрос;
	Запрос.Текст = 
	
	// ++ VOG Солодов В.В. 12.03.2020 CRM-436
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	вогРолиКонтактныхЛиц.КонтактноеЛицо КАК КонтактноеЛицо,
	|	вогРолиКонтактныхЛиц.CRM_РольКонтактногоЛица КАК РольКонтактногоЛица
	|ПОМЕСТИТЬ ВТ_КонтактныеЛица
	|ИЗ
	|	РегистрСведений.вогРолиКонтактныхЛиц КАК вогРолиКонтактныхЛиц
	|ГДЕ
	|	вогРолиКонтактныхЛиц.КонтактноеЛицо В(&КонтактныеЛица)
	|	И вогРолиКонтактныхЛиц.ОбъектСвязи В (&ОбъектСвязи)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	вогСвязиКонтактныхЛицСрезПоследних.КонтактноеЛицо,
	|	вогСвязиКонтактныхЛицСрезПоследних.CRM_РольКонтактногоЛица
	|ИЗ
	|	РегистрСведений.вогСвязиКонтактныхЛиц.СрезПоследних КАК вогСвязиКонтактныхЛицСрезПоследних
	|ГДЕ
	|	вогСвязиКонтактныхЛицСрезПоследних.КонтактноеЛицо В(&КонтактныеЛица)
	|	И вогСвязиКонтактныхЛицСрезПоследних.ОбъектСвязи В (&ОбъектСвязи)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ВТ_КонтактныеЛица.КонтактноеЛицо КАК КонтактноеЛицо,
	|	ВТ_КонтактныеЛица.РольКонтактногоЛица КАК РольКонтактногоЛица
	|ИЗ
	|	ВТ_КонтактныеЛица КАК ВТ_КонтактныеЛица
	|ИТОГИ ПО
	|	КонтактноеЛицо";
	// До изменения
	//"ВЫБРАТЬ
	//|	вогРолиКонтактныхЛиц.КонтактноеЛицо КАК КонтактноеЛицо,
	//|	вогРолиКонтактныхЛиц.CRM_РольКонтактногоЛица КАК РольКонтактногоЛица
	//|ИЗ
	//|	РегистрСведений.вогРолиКонтактныхЛиц КАК вогРолиКонтактныхЛиц
	//|ГДЕ
	//|	вогРолиКонтактныхЛиц.КонтактноеЛицо В(&КонтактныеЛица)
	//|	И вогРолиКонтактныхЛиц.ОбъектСвязи = &ОбъектСвязи
	//|ИТОГИ ПО
	//|	КонтактноеЛицо";
	// -- VOG Солодов В.В. 12.03.2020
	
	Запрос.УстановитьПараметр("КонтактныеЛица", Строки.ПолучитьКлючи());
	Запрос.УстановитьПараметр("ОбъектСвязи", ОбъектСвязи);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаКонтактноеЛицо = РезультатЗапроса.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	
	Пока ВыборкаКонтактноеЛицо.Следующий() Цикл
		
		Роли = "";
		
		ВыборкаДетальныеЗаписи = ВыборкаКонтактноеЛицо.Выбрать();
		Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
			Роли = Роли + ?(Роли = "","","; ") + ВыборкаДетальныеЗаписи.РольКонтактногоЛица;
		КонецЦикла;
		
		СтрокаСписка = Строки[ВыборкаКонтактноеЛицо.КонтактноеЛицо];
		СтрокаСписка.Данные.CRM_РольКонтактногоЛица = Роли;
		
	КонецЦикла;
	
КонецПроцедуры // --- VOG Кулаков П.Л.

#КонецОбласти

#Область ОбработчикиСобытийЭлементовТаблицыФормыСписок
//Код процедур и функций
#КонецОбласти

#Область ОбработчикиКомандФормы
//Код процедур и функций
#КонецОбласти

#Область СлужебныеПроцедурыИФункции
//Код процедур и функций
#КонецОбласти

// -- Тищенко В.В. 
